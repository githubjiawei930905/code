<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.epeibao.dao.ZongHeDao">

<!-- 手机网页端查询  市的总公司分组-->
<select id="findByParentCompanyID" resultType="java.util.LinkedHashMap">
select top(10)
    ParentCompanyID companyid,
    count(ifPaymentAssessment)-#{repeat} payMoney,
	count(ifVehicleMaintenanceAssessment)-#{repeat} vehicleMain ,
	count(ifExamine)-#{repeat} exam,
    count(ifDataAcquisition)-#{repeat} OpretionData, 
	count(distinct di.BusNumber) vehicleNum
from ComprehensiveAssessment ca,DriverInformation di,CompanyVehicleDriverRelation cvr
where ca.DriverID=di.DriverID and  di.DriverID = cvr.DriverID
and ifPaymentAssessment=1  and ifVehicleMaintenanceAssessment=1 and ifExamine=1 and ifDataAcquisition=1 
     and ca.ComprehensiveAssessmentID like  CONCAT('%',#{time},'%')   
	 and CityID =#{city}
     and   CityID
	       not in
	       (
		      select top((#{page}-1)*10) ParentCompanyID  from ComprehensiveAssessment ca,DriverInformation di,CompanyVehicleDriverRelation cvr
              where ca.DriverID=di.DriverID and  di.DriverID = cvr.DriverID
              and ifPaymentAssessment=1  and ifVehicleMaintenanceAssessment=1 and ifExamine=1 and ifDataAcquisition=1 
              and ca.ComprehensiveAssessmentID like  CONCAT('%',#{time},'%')   
	          and CityID = #{city}
			  group by 
			  ParentCompanyID
		   )
group by 
     ParentCompanyID
</select>

<!--总公司ID查分公司  --><!--1  -->
<select id="findByChildCompanyID" resultType="java.util.LinkedHashMap">
select top(10) (select distinct OrganizationName from OrganizationMessage where ParentOrganizationID = ChildCompanyID ) name,
    ChildCompanyID,
    count(ifPaymentAssessment)-#{repeat} payMoney,
	count(ifVehicleMaintenanceAssessment)-#{repeat} vehicleMain ,
	count(ifExamine)-#{repeat} exam,
    count(ifDataAcquisition)-#{repeat} OpretionData, 
	count(distinct di.BusNumber) vehicleNum
from ComprehensiveAssessment ca,DriverInformation di,CompanyVehicleDriverRelation cvr
where ca.DriverID=di.DriverID and  di.DriverID = cvr.DriverID
and ifPaymentAssessment=1  and ifVehicleMaintenanceAssessment=1 and ifExamine=1 and ifDataAcquisition=1 
     and ca.ComprehensiveAssessmentID like CONCAT('%',#{time},'%') 
	 and  ParentCompanyID = #{childCompanyID}
     and   ChildCompanyID
	       not in
	       (
		      select top((#{page}-1)*10) ChildCompanyID  from ComprehensiveAssessment ca,DriverInformation di,CompanyVehicleDriverRelation cvr
              where ca.DriverID=di.DriverID and  di.DriverID = cvr.DriverID
              and ifPaymentAssessment=1  and ifVehicleMaintenanceAssessment=1 and ifExamine=1 and ifDataAcquisition=1 
              and ca.ComprehensiveAssessmentID like CONCAT('%',#{time},'%')   
	          and ParentCompanyID = #{childCompanyID}
			  group by 
			  ChildCompanyID
		   )
group by     
	 ChildCompanyID
</select>


<!--根据分公司ID查大队信息  --><!-- 2 -->
<select id="findByVehicleTeamID" resultType="java.util.LinkedHashMap">
select top(10) (select distinct OrganizationName from OrganizationMessage where ParentOrganizationID = VehicleTeamID ) name,
    VehicleTeamID,
    count(ifPaymentAssessment)-#{repeat} payMoney,
	count(ifVehicleMaintenanceAssessment)-#{repeat} vehicleMain ,
	count(ifExamine)-#{repeat} exam,
    count(ifDataAcquisition)-#{repeat} OpretionData, 
	count(distinct di.BusNumber) vehicleNum
from ComprehensiveAssessment ca,DriverInformation di,CompanyVehicleDriverRelation cvr
where ca.DriverID=di.DriverID and  di.DriverID = cvr.DriverID
and ifPaymentAssessment=1  and ifVehicleMaintenanceAssessment=1 and ifExamine=1 and ifDataAcquisition=1 
     and ca.ComprehensiveAssessmentID like  CONCAT('%',#{time},'%')    
	 and ChildCompanyID = #{vehicleTeamID}
     and   VehicleTeamID
	       not in
	       (
		      select top((#{page}-1)*10) VehicleTeamID  from ComprehensiveAssessment ca,DriverInformation di,CompanyVehicleDriverRelation cvr
              where ca.DriverID=di.DriverID and  di.DriverID = cvr.DriverID
              and ifPaymentAssessment=1  and ifVehicleMaintenanceAssessment=1 and ifExamine=1 and ifDataAcquisition=1 
              and ca.ComprehensiveAssessmentID like  CONCAT('%',#{time},'%')    
	          and ChildCompanyID = #{vehicleTeamID}
			  group by 
			  VehicleTeamID
		   )
group by 
	 VehicleTeamID
</select>


<!-- 根据大队ID查看中队信息 --><!--3  -->
<select id="findByVehicleZhongTeamID" resultType="java.util.LinkedHashMap">
select top(10) (select distinct OrganizationName from OrganizationMessage where ParentOrganizationID = VehicleZhongTeamID ) name,
    VehicleZhongTeamID,
    count(ifPaymentAssessment)-#{repeat} payMoney,
	count(ifVehicleMaintenanceAssessment)-#{repeat} vehicleMain ,
	count(ifExamine)-#{repeat} exam,
    count(ifDataAcquisition)-#{repeat} OpretionData, 
	count(distinct di.BusNumber) vehicleNum
from ComprehensiveAssessment ca,DriverInformation di,CompanyVehicleDriverRelation cvr
where ca.DriverID=di.DriverID and  di.DriverID = cvr.DriverID
and ifPaymentAssessment=1  and ifVehicleMaintenanceAssessment=1 and ifExamine=1 and ifDataAcquisition=1 
     and ca.ComprehensiveAssessmentID like CONCAT('%',#{time},'%')   
	 and VehicleTeamID = #{vehicleZhongTeamID}
     and   VehicleZhongTeamID
	       not in
	       (
		      select top((#{page}-1)*10) VehicleZhongTeamID  from ComprehensiveAssessment ca,DriverInformation di,CompanyVehicleDriverRelation cvr
              where ca.DriverID=di.DriverID and  di.DriverID = cvr.DriverID
              and ifPaymentAssessment=1  and ifVehicleMaintenanceAssessment=1 and ifExamine=1 and ifDataAcquisition=1 
              and ca.ComprehensiveAssessmentID like CONCAT('%',#{time},'%')  
	          and VehicleTeamID =  #{vehicleZhongTeamID}
			  group by 
			  VehicleZhongTeamID
		   )
group by 
	 VehicleZhongTeamID
</select>

<!-- 根据中队ID查看小队信息  --><!--  4-->
<select id="findByVehicleGroupID" resultType="java.util.LinkedHashMap">
select top(10) (select distinct OrganizationName from OrganizationMessage where ParentOrganizationID = VehicleGroupID ) name,
    VehicleGroupID,
    count(ifPaymentAssessment)-#{repeat} payMoney,
	count(ifVehicleMaintenanceAssessment)-#{repeat} vehicleMain ,
	count(ifExamine)-#{repeat} exam,
    count(ifDataAcquisition)-#{repeat}  OpretionData, 
	count(distinct di.BusNumber) vehicleNum
from ComprehensiveAssessment ca,DriverInformation di,CompanyVehicleDriverRelation cvr
where ca.DriverID=di.DriverID and  di.DriverID = cvr.DriverID
and ifPaymentAssessment=1  and ifVehicleMaintenanceAssessment=1 and ifExamine=1 and ifDataAcquisition=1 
     and ca.ComprehensiveAssessmentID like CONCAT('%',#{time},'%')   
	 and VehicleZhongTeamID = #{vehicleGroupID}
     and   VehicleGroupID
	       not in
	       (
		      select  top((#{page}-1)*10) VehicleGroupID  from ComprehensiveAssessment ca,DriverInformation di,CompanyVehicleDriverRelation cvr
              where ca.DriverID=di.DriverID and  di.DriverID = cvr.DriverID
              and ifPaymentAssessment=1  and ifVehicleMaintenanceAssessment=1 and ifExamine=1 and ifDataAcquisition=1 
              and ca.ComprehensiveAssessmentID like CONCAT('%',#{time},'%')   
	          and VehicleZhongTeamID = #{vehicleGroupID}
			  group by 
			  VehicleGroupID
		   )
group by 
	 VehicleGroupID
</select>

<!--  根据小队信息查看车辆信息 --><!-- 5 -->
<select id="findBusNum" resultType="java.util.LinkedHashMap">
select top(10)  di.BusNumber busnum,ifPaymentAssessment,ifVehicleMaintenanceAssessment,ifExamine,ifDataAcquisition    
from ComprehensiveAssessment ca,DriverInformation di,CompanyVehicleDriverRelation cvr
where ca.DriverID=di.DriverID and  di.DriverID = cvr.DriverID
and ifPaymentAssessment=1  and ifVehicleMaintenanceAssessment=1 and ifExamine=1 and ifDataAcquisition=1 
     and ca.ComprehensiveAssessmentID like CONCAT('%',#{time},'%') 
	 and VehicleGroupID = #{vehicleGroupID}
     and    di.BusNumber
	       not in
	       (
		      select  top((#{page}-1)*10)   di.BusNumber  from ComprehensiveAssessment ca,DriverInformation di,CompanyVehicleDriverRelation cvr
              where ca.DriverID=di.DriverID and  di.DriverID = cvr.DriverID
              and ifPaymentAssessment=1  and ifVehicleMaintenanceAssessment=1 and ifExamine=1 and ifDataAcquisition=1 
              and ca.ComprehensiveAssessmentID like CONCAT('%',#{time},'%')     
	          and VehicleGroupID = #{vehicleGroupID}
		   )
</select>


<!---查询双包车对应的车有多少 辆四项都通过的人数    取 最后一列的最大值 -->
<select id="findBusNumerNum" resultType="java.util.LinkedHashMap">
select di.BusNumber busnum ,count(distinct di.DriverID) num,  ROW_NUMBER() over(order by di.BusNumber) as rows
from ComprehensiveAssessment ca,DriverInformation di,CompanyVehicleDriverRelation cvr
where ifPaymentAssessment=1  and ifVehicleMaintenanceAssessment=1 and ifExamine=1 and ifDataAcquisition=1 
<if test="id!=null and level == 1">
   and ParentCompanyID =#{id}
</if>
<if test="id!=null and level == 2">
   and ChildCompanyID =#{id}
</if>
<if test="id!=null and level == 3">
   and VehicleTeamID =#{id}
</if>
<if test="id!=null and level == 4">
   and VehicleZhongTeamID =#{id}
</if>
<if test="id!=null and level == 5">
   and VehicleGroupID =#{id}
</if>
 group by di.BusNumber 
 having count(distinct di.DriverID)=2
</select>




<select id="findByNameOrBusnumPhone"  resultType="java.util.LinkedHashMap">
select top(10)  d.DriverName username,d.DriverID driverId,d.BusNumber busnum,ifPaymentAssessment,ifVehicleMaintenanceAssessment,ifExamine,ifDataAcquisition 
 from ComprehensiveAssessment c ,DriverInformation d,CompanyVehicleDriverRelation cd
where c.DriverID = d.DriverID and d.DriverID = cd.DriverID
	  <if test="driverName != null and driverName != ''">
		   and DriverName like CONCAT('%',#{driverName},'%') 
	   </if>
	   <if test="busNumber != null and busNumber != ''">
		   and d.BusNumber like CONCAT('%',#{busNumber},'%') 
	   </if>
  and  c.ComprehensiveAssessmentID like   CONCAT('%',#{time},'%')  
    <if test="ognaizetionId!=null and ognaizetionId!=''  and level ==1 ">and ParentCompanyID =#{ognaizetionId}</if>
    <if test="ognaizetionId!=null and ognaizetionId!=''  and level ==2 ">and ChildCompanyID =#{ognaizetionId}</if>
    <if test="ognaizetionId!=null and ognaizetionId!=''  and level ==3 ">and VehicleTeamID =#{ognaizetionId}</if>
    <if test="ognaizetionId!=null and ognaizetionId!=''  and level ==4 ">and VehicleZhongTeamID =#{ognaizetionId}</if>
    <if test="ognaizetionId!=null and ognaizetionId!=''  and level ==5 ">and VehicleGroupID =#{ognaizetionId}</if>    
and d.DriverID
not in 
	(
	select top((#{page}-1)*10)  d.DriverID 
      from ComprehensiveAssessment c ,DriverInformation d,CompanyVehicleDriverRelation cd
        where c.DriverID = d.DriverID and d.DriverID = cd.DriverID
	   and 1=1 
	   <if test="driverName != null and driverName != ''">
		   and DriverName like CONCAT('%',#{driverName},'%') 
	   </if>
	   <if test="busNumber != null and busNumber != ''">
		   and d.BusNumber like CONCAT('%',#{busNumber},'%') 
	   </if>
		    and  c.ComprehensiveAssessmentID like   CONCAT('%',#{time},'%') 
    <if test="ognaizetionId==null and ognaizetionId!=''  and level ==1 ">and ParentCompanyID =#{ognaizetionId}</if>
    <if test="ognaizetionId==null and ognaizetionId!=''  and level ==2 ">and ChildCompanyID =#{ognaizetionId}</if>
    <if test="ognaizetionId==null and ognaizetionId!=''  and level ==3 ">and VehicleTeamID =#{ognaizetionId}</if>
    <if test="ognaizetionId==null and ognaizetionId!=''  and level ==4 ">and VehicleZhongTeamID =#{ognaizetionId}</if>
    <if test="ognaizetionId==null and ognaizetionId!=''  and level ==5 ">and VehicleGroupID =#{ognaizetionId}</if>   
	order by DriverID
	)
order by d.DriverID

</select>

<!--车牌号查询所属的公司名  -->
<select id="findByBusnum" resultType="java.util.LinkedHashMap" parameterType="java.lang.String">
select distinct
(select OrganizationName from OrganizationMessage o, UserMessage u
where o.OrganizationID = u.OrganizationID and o.OrganizationID = ParentCompanyID) parentCompanyName,
(select OrganizationName from OrganizationMessage o, UserMessage u
where o.OrganizationID = u.OrganizationID and o.OrganizationID =ChildCompanyID) childCompanyName,
(select OrganizationName from OrganizationMessage o, UserMessage u
where o.OrganizationID = u.OrganizationID and o.OrganizationID = VehicleTeamID) vehicleTeamName,
(select OrganizationName from OrganizationMessage o, UserMessage u
where o.OrganizationID = u.OrganizationID and o.OrganizationID = VehicleZhongTeamID) vehicleZhongTeamName,
(select OrganizationName from OrganizationMessage o, UserMessage u
where o.OrganizationID = u.OrganizationID and o.OrganizationID = VehicleGroupID) vehicleGroupName
from CompanyVehicleDriverRelation
where  BusNumber =  #{busnum}
</select>


<!-- 根据省ID查看城市的信息 -->
<select id="findByCity" resultType="java.util.LinkedHashMap">
select top(10)
    CityID,
    count(ifPaymentAssessment)-#{repeat} payMoney,
	count(ifVehicleMaintenanceAssessment)-#{repeat} vehicleMain ,
	count(ifExamine)-#{repeat} exam,
    count(ifDataAcquisition)-#{repeat} OpretionData, 
	count(distinct di.BusNumber) vehicleNum
from ComprehensiveAssessment ca,DriverInformation di,CompanyVehicleDriverRelation cvr
where ca.DriverID=di.DriverID and  di.DriverID = cvr.DriverID
and ifPaymentAssessment=1  and ifVehicleMaintenanceAssessment=1 and ifExamine=1 and ifDataAcquisition=1 
     and ca.ComprehensiveAssessmentID like  CONCAT('%',#{time},'%')   
	 and ProvinceID = #{sheng}
     and   CityID
	       not in
	       (
		      select top((#{page}-1)*10) CityID  from ComprehensiveAssessment ca,DriverInformation di,CompanyVehicleDriverRelation cvr
              where ca.DriverID=di.DriverID and  di.DriverID = cvr.DriverID
              and ifPaymentAssessment=1  and ifVehicleMaintenanceAssessment=1 and ifExamine=1 and ifDataAcquisition=1 
              and ca.ComprehensiveAssessmentID like CONCAT('%',#{time},'%')   
	          and ProvinceID = #{sheng}
			  group by 
			  CityID
		   )
group by 
	 CityID
</select>

<!--根据组织名称查询老总名字  -->
<select id="findOrganizationIDByName" resultType="java.lang.String" parameterType="java.lang.String">
select UserName from OrganizationMessage o, UserMessage u
where o.OrganizationID = u.OrganizationID
and o.OrganizationID =  #{organizationID}
</select>


<!-- 根据组织ID查询儿子和孙子的级别 -->
<select id="findLevel" parameterType="java.lang.String" resultType="Integer">
select distinct top(2) OrganizationLevel from OrganizationMessage 
where OrganizationID  like CONCAT('%',#{organizationID},'%')  
      and OrganizationID !=#{organizationID}
</select>

</mapper>