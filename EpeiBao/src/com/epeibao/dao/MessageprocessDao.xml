<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.epeibao.dao.MessageprocessDao" >
  <resultMap id="BaseResultMap" type="com.epeibao.po.Messageprocess" >
    <id column="RecordID" property="recordid" jdbcType="VARCHAR" />
    <result column="UserID" property="userid" jdbcType="VARCHAR" />
    <result column="MessageID" property="messageid" jdbcType="VARCHAR" />
    <result column="ProcessType" property="processtype" jdbcType="TINYINT" />
    <result column="Processtime" property="processtime" jdbcType="TIMESTAMP" />
  </resultMap>
 
   <resultMap id="Message" type="java.util.LinkedHashMap">
    <id column="MessageID" property="MessageID" typeHandler="com.epeibao.controller.converter.EmptyStringIfNull"  />
    <result column="UserID" property="userid" typeHandler="com.epeibao.controller.converter.EmptyStringIfNull" />
    <result column="Messagedescribe" property="Messagedescribe" typeHandler="com.epeibao.controller.converter.EmptyStringIfNull"  />
    <result column="MessageLevel" property="MessageLevel" typeHandler="com.epeibao.controller.converter.EmptyStringIfNull"  />
    <result column="MessageStatus" property="MessageStatus" typeHandler="com.epeibao.controller.converter.EmptyStringIfNull"  />
    <result column="BuildTime" property="BuildTime" typeHandler="com.epeibao.controller.converter.EmptyStringIfNull"  />
    <result column="ExpiredOfValidity" property="ExpiredOfValidity" typeHandler="com.epeibao.controller.converter.EmptyStringIfNull"  />
 	 <result column="ProcessType" property="ProcessType" typeHandler="com.epeibao.controller.converter.EmptyStringIfNull"  />
    <result column="Processtime" property="Processtime" typeHandler="com.epeibao.controller.converter.EmptyStringIfNull"  />
  	<result column="RecordID" property="RecordID" typeHandler="com.epeibao.controller.converter.EmptyStringIfNull"  />
  	<result column="MessageTitle" property="MessageTitle" typeHandler="com.epeibao.controller.converter.EmptyStringIfNull"  />
  	<result column="ComeUserID" property="ComeUserID" typeHandler="com.epeibao.controller.converter.EmptyStringIfNull"  />
  	
  	
  </resultMap>
  
  <sql id="Base_Column_List" >
    RecordID, UserID, MessageID, ProcessType, Processtime
  </sql>
  
  
     <select id="findByRecordid"  resultType="com.epeibao.po.Messageprocess">
    select 
 	 <include refid="Base_Column_List" />
    from MessageProcess
   	where RecordID = #{recordid,jdbcType=VARCHAR}
  </select>
  
   <select id="findByState"  resultType="com.epeibao.po.Messageprocess">
    select 
 	 <include refid="Base_Column_List" />
    from MessageProcess
   	where UserID = #{userid,jdbcType=VARCHAR} and ProcessType = #{ProcessType,jdbcType=TINYINT}
  </select>
  
     <select id="findByMessageState"  resultType="com.epeibao.po.Messageprocess">
    select 
 	 <include refid="Base_Column_List" />
    from MessageProcess
   	where MessageID = #{messageid,jdbcType=VARCHAR} and ProcessType = #{ProcessType,jdbcType=TINYINT}
  </select>
 
 <select id="findByUserId"  resultMap="Message">
   select top 15  m.MessageID,m.MessageTitle,m.ComeUserID,m.Messagedescribe,m.MessageLevel,m.MessageStatus,m.BuildTime,m.ExpiredOfValidity,mp.ProcessType,mp.Processtime,mp.RecordID,mp.UserID
    from Message  m join MessageProcess mp
    on m.MessageLevel=1 and m.MessageStatus=5 and mp.UserID = #{userid,jdbcType=VARCHAR} and m.MessageID=mp.MessageID
	and  m.MessageID not in
    (select top (#{page}*15) m.MessageID 
	 from Message  m join MessageProcess mp
    on  m.MessageLevel=1  and m.MessageStatus=5 and mp.UserID = #{userid,jdbcType=VARCHAR} and m.MessageID=mp.MessageID order by BuildTime desc )
    union
       select top 15  m.MessageID,m.MessageTitle,m.ComeUserID,m.Messagedescribe,m.MessageLevel,m.MessageStatus,m.BuildTime,m.ExpiredOfValidity,mp.ProcessType,mp.Processtime,mp.RecordID,mp.UserID
    from Message  m join MessageProcess mp
    on m.MessageLevel=2 and m.MessageStatus=5 and mp.UserID = #{userid,jdbcType=VARCHAR} and m.MessageID=mp.MessageID
	and  m.MessageID not in
    (select top (#{page}*15) m.MessageID 
	 from Message  m join MessageProcess mp
    on m.MessageLevel=2 and m.MessageStatus=5 and mp.UserID = #{userid,jdbcType=VARCHAR} and m.MessageID=mp.MessageID order by BuildTime desc )
    union
       select top 15   m.MessageID,m.MessageTitle,m.ComeUserID,m.Messagedescribe,m.MessageLevel,m.MessageStatus,m.BuildTime,m.ExpiredOfValidity,mp.ProcessType,mp.Processtime,mp.RecordID,mp.UserID
    from Message  m join MessageProcess mp
    on  m.MessageLevel=3 and m.MessageStatus=5 and mp.UserID = #{userid,jdbcType=VARCHAR} and m.MessageID=mp.MessageID
	and  m.MessageID not in
    (select top (#{page}*15) m.MessageID 
	 from Message  m join MessageProcess mp
    on m.MessageLevel=3 and m.MessageStatus=5 and  mp.UserID = #{userid,jdbcType=VARCHAR} and m.MessageID=mp.MessageID order by BuildTime desc )
    order by MessageLevel asc,BuildTime desc
  </select> 
 
 
  <select id="findByid"  resultMap="Message" parameterType="java.lang.String" >
    select 
 	m.*,mp.ProcessType,mp.Processtime,mp.RecordID
    from Message  m join MessageProcess mp
    on m.MessageID=mp.MessageID and mp.RecordID = #{recordid,jdbcType=VARCHAR}
  </select>
  
    <select id="findBymessageid"  resultType="com.epeibao.po.Messageprocess" parameterType="java.lang.String" >
    select 
    <include refid="Base_Column_List" />
    from MessageProcess
    where MessageID = #{messageid,jdbcType=VARCHAR}
  </select>
  
  <delete id="deleteMessageprocess" parameterType="java.lang.String" >
    delete from MessageProcess
    where RecordID = #{recordid,jdbcType=VARCHAR}
  </delete>
  
  <insert id="insertMesagsageprocess" parameterType="com.epeibao.po.Messageprocess" >
    insert into MessageProcess (RecordID, UserID, MessageID, 
      ProcessType, Processtime)
    values (#{recordid,jdbcType=VARCHAR}, #{userid,jdbcType=VARCHAR}, #{messageid,jdbcType=VARCHAR}, 
      #{processtype,jdbcType=TINYINT}, #{processtime,jdbcType=TIMESTAMP})
  </insert>
  
    <insert id="insertListMesagsageprocess" parameterType="com.epeibao.po.Messageprocess" >
    insert into MessageProcess (RecordID, UserID, MessageID, 
      ProcessType, Processtime)
    values 
    <foreach collection="list" item="list" index="index" separator=",">
     (#{list.recordid,jdbcType=VARCHAR}, #{list.userid,jdbcType=VARCHAR}, #{list.messageid,jdbcType=VARCHAR}, 
      #{list.processtype,jdbcType=TINYINT}, #{list.processtime,jdbcType=TIMESTAMP})
    </foreach>
   
  </insert>
 
  <update id="updateMessageprocess" parameterType="com.epeibao.po.Messageprocess" >
    update MessageProcess
    set UserID = #{userid,jdbcType=VARCHAR},
      MessageID = #{messageid,jdbcType=VARCHAR},
      ProcessType = #{processtype,jdbcType=TINYINT},
      Processtime = #{processtime,jdbcType=TIMESTAMP}
    where RecordID = #{recordid,jdbcType=VARCHAR}
  </update>
</mapper>